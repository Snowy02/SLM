# --- REPLACEMENT FUNCTION for lines 141-193 ---

def repository_action_selected_by_user(repository, action):
    # This function returns 3 updates, in this order:
    # 1. for classes_radio_group
    # 2. for repo_dependency_output
    # 3. for class_diagram_output

    if not repository:
        gr.Warning("Please select a repository first.")
        # Hide all three outputs
        return gr.update(visible=False), gr.update(visible=False), gr.update(visible=False)

    if action == "LIST CLASSES":
        query = f"MATCH (r:Repository {{name: '{repository}'}})-[:HAS_CLASSES]->(c:Class) RETURN c.name as name"
        result = query_handler.extract_result_for_query(query)
        classes = [x['name'] for x in result] if result else []
        # Show ONLY the class list, hide the other two
        return gr.update(visible=True, choices=classes, value=None), gr.update(visible=False), gr.update(visible=False)

    elif action == "LIST DEPENDENCIES":
        query = f"MATCH (r:Repository {{name: '{repository}'}})-[:DEPENDS_ON]->(dep:Repository) RETURN dep.name as `Depends On`"
        result = query_handler.extract_result_for_query(query)
        if result:
            output_df = pd.DataFrame(result)
            # Show ONLY the dependency dataframe, hide the other two
            return gr.update(visible=False), gr.update(visible=True, value=output_df), gr.update(visible=False)
        else:
            output_df = "No repository dependencies found for this repository."
            # Show ONLY the dependency dataframe (with a message), hide the other two
            return gr.update(visible=False), gr.update(visible=True, value=output_df), gr.update(visible=False)
            
    elif action == "CLASS DIAGRAM":
        query = f"MATCH (n:Repository {{name: '{repository}'}})-[r1]->(c:Class)-[r2]->(m:Method) return n,r1,c,r2,m"
        result = query_handler.extract_result_for_query(query)

        if not result:
            output_string = "No classes or methods found to generate a diagram."
        else:
            # (Your existing, correct Mermaid generation logic)
            def sanitize_mermaid_name(name):
                if not isinstance(name, str):
                    name = str(name)
                return re.sub(r'[^a-zA-Z0-9_]', '_', name)

            methods_by_class = {}
            for row in result:
                class_name = sanitize_mermaid_name(row['c']['name'])
                method_name = row['m']['name']
                return_type = sanitize_mermaid_name(row['m'].get('return_type', 'void'))
                if class_name not in methods_by_class:
                    methods_by_class[class_name] = []
                methods_by_class[class_name].append(f"+{method_name}() : {return_type}")

            mermaid_lines = ["```mermaid", "classDiagram"]
            for class_name, methods in methods_by_class.items():
                if not class_name: continue
                mermaid_lines.append(f"    class {class_name} {{")
                for method_signature in methods:
                    mermaid_lines.append(f"        {method_signature}")
                mermaid_lines.append("    }")
            mermaid_lines.append("```")
            output_string = "\n".join(mermaid_lines)

        print("--- GENERATED MERMAID DIAGRAM ---")
        print(output_string)
        print("---------------------------------")
        
        # Show ONLY the diagram, hide the other two
        return gr.update(visible=False), gr.update(visible=False), gr.update(visible=True, value=output_string)

    # Default case if no action matches
    return gr.update(visible=False), gr.update(visible=False), gr.update(visible=False)

# --- END OF REPLACEMENT ---
